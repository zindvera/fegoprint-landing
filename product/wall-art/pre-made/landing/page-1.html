<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-made Wall Art Landing</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../loader.css">
    <script src="../../../../loader.js" defer></script>
    <link rel="stylesheet" href="../../../../footer.css">
    <script src="../../../../footer.js" defer></script>
    <style>
        /* Base Styles */
        html,
        body {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            background-color: #f8f9fa;
            color: #212529;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 70px;
        }

        /* Navigation Styles */
        .navbar {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .navbar-brand {
            font-weight: 800;
            color: #0d6efd !important;
        }

        .nav-link {
            font-weight: 600;
            color: #495057 !important;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);

        }

        .hero-title {
            font-weight: 800;
            color: #1a1a1a;
            letter-spacing: -0.04em;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 32px;
            /* Desktop View */
            line-height: 1.1;
            min-height: 1.2em;
        }

        .hero-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 2rem !important;
            font-size: 1.25rem;
        }

        /* Format Switcher Styles */
        .format-switcher {
            display: flex;
            gap: 12px;
            margin-bottom: 2rem;
            margin-top: 1.75rem;
            width: 100%;
            max-width: 480px;
        }

        .format-option {
            flex: 1;
            padding: 12px 15px;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 100px;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .format-option:hover {
            border-color: #0d6efd;
            color: #0d6efd;
        }

        .format-option.active {
            color: #fff;
            background-color: #0d6efd;
            border-color: #0d6efd;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
        }

        /* Process Flow */
        .process-steps {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 2rem 0;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0d6efd;
            font-size: 1.25rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-label {
            font-weight: 700;
            font-size: 0.9rem;
            color: #495057;
        }

        .step-arrow {
            color: #a8a8a8;
            font-size: 1rem;
            margin-bottom: 25px;
        }

        /* Clarity Component */
        .clarity-feature {
            background-color: #fff;
            border-left: 4px solid #0d6efd;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
            margin-bottom: 2.5rem;
        }

        .clarity-feature i {
            color: #198754;
            font-size: 1.2rem;
        }

        .clarity-text {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a1a1a;
            margin: 0;
        }

        /* CTA & Price */
        .cta-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #0d6efd;
            color: #fff;
            font-weight: 800;
            padding: 1.25rem 3.5rem;
            font-size: 1.4rem;
            border-radius: 100px;
            text-decoration: none;
            box-shadow: 0 10px 25px rgba(13, 110, 253, 0.2);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(13, 110, 253, 0.35);
            background-color: #0b5ed7;
            color: #fff;
        }

        /* Floating CTA Specific Styles */
        .floating-cta {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 4000;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .floating-cta.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .price-display {
            margin-top: 1.5rem;
            color: #6c757d;
            font-size: 18px;
        }

        .price-value {
            color: #000;
            font-weight: 800;
            font-size: 1.5rem;
        }

        /* Trust Section */
        .trust-badge-block {
            display: none;
            align-items: center;
            margin-bottom: 2rem;
            gap: 15px;
            padding: 1rem 1.5rem;
            border-top: 1px solid #dee2e6;
            width: fit-content;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
            border-radius: 12px;
        }

        .trust-badge-block:hover {
            background-color: rgba(0, 0, 0, 0.03);
            transform: scale(1.02);
        }

        .brand-logo-img {
            width: 90px;
            height: auto;
            max-height: 36px;
            object-fit: contain;
            filter: grayscale(1);
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .trust-badge-block:hover .brand-logo-img {
            filter: grayscale(0);
            opacity: 1;
        }

        .rating-container {
            display: flex;
            flex-direction: column;
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
        }

        .star-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
        }

        .fa-star,
        .fa-star-half-alt {
            color: #ffc107;
            font-size: 0.9rem;
        }

        .far.fa-star {
            color: #dee2e6;
            /* Empty star color */
        }

        .rating-score {
            font-weight: 800;
            color: #212529;
            margin-right: 4px;
        }

        .rating-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: #000;
            /* Ratings label always black as requested */
            line-height: 1;
        }

        .review-count {
            color: #0d6efd;
            font-weight: 700;
        }

        /* Slider Styles */
        .slider-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            background: transparent;
            aspect-ratio: 4/5;
        }

        .slider-track {
            display: flex;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            height: 100%;
        }

        .slider-track img {
            min-width: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            cursor: zoom-in;
            background: transparent;
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            color: #000;
            font-size: 1.2rem;
        }

        .slider-arrow:hover {
            background: #000;
            color: #fff;
        }

        .arrow-left {
            left: 15px;
        }

        .arrow-right {
            right: 15px;
        }

        .slider-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 1.5rem;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot.active {
            background-color: #0d6efd;
            transform: scale(1.2);
        }

        /* Mockup Grid Styles */
        .mockup-container {
            padding: 2rem 0;
            background-color: transparent;
        }

        .mockup-img {
            width: 100%;
            height: auto;
            display: block;
            cursor: zoom-in;
            background-color: transparent;
        }

        .mockup-item {
            margin-bottom: 24px;
        }

        /* Image Modal */
        #img-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 5000;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }

        #img-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-view-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
        }

        #modal-zoom-img {
            max-width: 95%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.2s ease-out;
            cursor: grab;
            will-change: transform;
        }

        #modal-zoom-img:active {
            cursor: grabbing;
        }

        .modal-close-circle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 44px;
            height: 44px;
            background: #fff;
            border: none;
            border-radius: 50%;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5100;
            font-size: 1.2rem;
        }

        .modal-zoom-controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 0.5rem 1.2rem;
            border-radius: 100px;
            z-index: 5100;
            align-items: center;
            color: white;
        }

        .modal-zoom-btn {
            background: white;
            border: none;
            color: #333;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }



        /* Loading Spinner Styles */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            background: #f0f0f0;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border: 0.25em solid #dee2e6;
            border-right-color: #0d6efd;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .mockup-item {
            min-height: 300px;
            /* Prevents layout shift while loading */
            position: relative;
        }


        .format-badge {
            background: #ffffff;
            border: 1px solid #dee2e6;
            padding: 10px 24px;
            border-radius: 100px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            width: fit-content;
        }

        @media (max-width: 767.98px) {
            .format-switcher {
                justify-content: center !important;
            }
        }


        /* Responsive Breakpoints */
        @media (max-width: 991.98px) {
            .hero-title {
                font-size: 28px;
                /* Tablet View */
            }
        }

        @media (max-width: 767.98px) {
            .hero-title {
                font-size: 25px;
                /* Phone View */
                text-align: center;
            }

            .gradient-bg {
                padding: 4rem 0;
            }

            header .row>* {
                margin-top: 0 !important;
                /* Remove top gutter margin in phone view */
            }

            .hero-text {
                text-align: center;
                padding-top: 0.2in;
                padding-bottom: 0.15in;
            }

            .format-switcher {
                margin: 2rem auto 1.35rem auto;
            }

            .trust-badge-block {
                margin: 20px auto 25px auto;
            }

            .process-steps {
                justify-content: center;
            }

            /* Center Hero CTA in Phone view */
            .hero-actions {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .price-display {
                text-align: center;
            }

            /* Specific logic for Phone View: 6px margin from body edges */
            .mockup-container .container {
                padding-left: 6px !important;
                padding-right: 6px !important;
                max-width: none !important;
            }

            .mockup-container .row {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .mockup-item {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-bottom: 12px;
            }

            /* Floating CTA Full Width at Center on Phone */
            .floating-cta {
                left: 6px;
                right: 6px;
                bottom: 10px;
                padding: 0.8rem 1rem;
                font-size: 1rem;
                text-align: center;
                border-radius: 12px;
                width: calc(100% - 12px);
            }
        }
    </style>
</head>

<body>

    <div id="main-content">
        <div class="navdiv"></div>

        <header class="gradient-bg" id="topSection">
            <div class="container">
                <div class="row g-5 align-items-center">
                    <!-- Mobile Title -->
                    <div class="col-12 d-md-none text-center">
                        <h1 class="hero-title"></h1>
                    </div>

                    <!-- Image Slider -->
                    <div class="col-12 col-md-6">
                        <div class="slider-container" id="mainSlider">
                            <button class="slider-arrow arrow-left" onclick="moveSlide(-1, true)"><i
                                    class="fas fa-chevron-left"></i></button>
                            <div class="slider-track" id="sliderTrack"></div>
                            <button class="slider-arrow arrow-right" onclick="moveSlide(1, true)"><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="sliderDots" class="slider-dots"></div>
                    </div>

                    <!-- Text Content -->
                    <div class="col-12 col-md-6 ps-lg-5">


                        <a id="trustLink" href="#" target="_blank" class="trust-badge-block"
                            style="text-decoration: none;">
                            <div id="brandTextContainer"
                                style="display: flex; flex-direction: column; gap: 0; padding-right: 15px;">
                                <span
                                    style="font-size: 0.85rem; color: #272727; font-weight: 400; line-height: 1.2;">Available
                                    on</span>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span id="brandDomainDisplay"
                                        style="font-size: 1.1rem; font-weight: 600; color: #0d6efd;"></span>
                                    <i class="fas fa-external-link-alt"
                                        style="font-size: 0.8rem; color: #0d6efd; opacity: 0.8;"></i>
                                </div>
                            </div>

                            <div class="rating-container" id="ratingContainer">
                                <div class="star-row" id="starRow"></div>
                                <div class="rating-text">

                                    <h6 style="margin:0;" class="review-count" id="reviewCountText"></h6>
                                </div>
                            </div>
                        </a>


                        <h1 class="hero-title d-none d-md-block"></h1>

                        <div class="format-switcher">

                            <div class="format-option active" id="opt-physical" onclick="switchFormat('physical')">
                                <i class="fa-solid fa-truck"></i> Physical Poster
                            </div>
                            <div class="format-option " id="opt-digital" onclick="switchFormat('digital')">
                                <i class="fas fa-download"></i> Instant Digital
                            </div>
                        </div>

                        <p class="hero-text" id="formatDesc">
                            Download the high-resolution file instantly.
                            <strong>Perfect for printing yourself.</strong>
                        </p>

                        <!-- Process Steps -->
                        <div class="process-steps" id="processStepsContainer">
                            <div class="step-item">
                                <div class="step-icon"><i class="fas fa-credit-card"></i></div>
                                <span class="step-label">Pay</span>
                            </div>
                            <i class="fas fa-chevron-right step-arrow"></i>
                            <div class="step-item">
                                <div class="step-icon"><i class="fas fa-download"></i></div>
                                <span class="step-label">Download</span>
                            </div>
                            <i class="fas fa-chevron-right step-arrow"></i>
                            <div class="step-item">
                                <div class="step-icon"><i class="fas fa-print"></i></div>
                                <span class="step-label">Print</span>
                            </div>
                        </div>

                        <div class="clarity-feature">
                            <i class="fas fa-circle-check"></i>
                            <p class="clarity-text" id="clarityText">High Quality PDF File - Ready For Print</p>
                        </div>

                        <div class="hero-actions">
                            <a id="heroCTA" href="#" target="_blank" class="cta-button">Download File</a>
                            <div class="price-display">

                                <p id="priceValueContainer">Price: <span class="price-value" id="priceValue">$10.50
                                        USD</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="mockup-container">
            <div class="container">
                <div class="row g-md-4 g-2" id="mockupGrid"></div>
            </div>
        </section>

        <!-- Floating CTA (Link to platform) -->
        <a id="floatingCTA" href="#" target="_blank" class="cta-button floating-cta">Get this Poster</a>

        <!-- Image Modal -->
        <div id="img-modal-overlay">
            <button class="modal-close-circle" id="close-view-modal"><i class="fas fa-times"></i></button>
            <div class="modal-view-container" id="modal-container">
                <img id="modal-zoom-img" src="" alt="Zoomed View">
            </div>
            <div class="modal-zoom-controls">
                <button class="modal-zoom-btn" id="btn-zoom-out"><i class="fas fa-minus"></i></button>
                <span id="zoom-percent-text">100%</span>
                <button class="modal-zoom-btn" id="btn-zoom-in"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </div>

    <script src="../../../../../nav.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        // Default to design '1' if the parameter is not provided
        const designId = urlParams.get('design') || '1';
        const baseDir = `../designs/${designId}/images/`;
        const jsonPath = `../designs/${designId}/data.json`;
        const brandsJsonPath = `../../../../brands.json`;

        let currentSlide = 0;
        let images = [];
        let zoomLevel = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let autoSlideTimer = null;


        const formats = {
            digital: {
                desc: "Download the high-resolution file instantly. <strong>Perfect for printing yourself.</strong>",
                steps: [
                    { icon: 'fa-credit-card', label: 'Pay' },
                    { icon: 'fa-download', label: 'Download' },
                    { icon: 'fa-print', label: 'Print' }
                ],
                clarity: "High Quality PDF File",
                cta: "Shop on", // Platform name added dynamically in JS
                subtext: "Instant high-quality PDF download",
                price: "",
                link: "#"
            },
            physical: {
                desc: "Professional printing on premium paper. <strong>Order & get your poster delivered to your door.</strong>",
                steps: [
                    { icon: 'fa-shopping-basket', label: 'Order' },
                    { icon: 'fa-credit-card', label: 'Pay' },
                    { icon: 'fa-truck-fast', label: 'Shipped' }
                ],
                clarity: "Physical Wall Art Delivery",
                cta: "Shop on", // Platform name added dynamically in JS
                subtext: "Choose your custom size and framing",
                price: "",
                link: "#"
            }
        };

        // Global variable to store the extracted brand name
        let platformName = "Store";



        let touchStartX = 0;
        let touchEndX = 0;

        // Update your window.onload or simply add these listeners
        async function initTouchSlider() {
            const track = document.getElementById('sliderTrack');

            track.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                // Pause auto-slide when user interacts
                if (autoSlideTimer) clearInterval(autoSlideTimer);
            }, { passive: true });

            track.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
                startAutoSlide(); // Resume auto-slide
            }, { passive: true });
        }

        function handleSwipe() {
            const swipeThreshold = 50; // Minimum distance in pixels to count as a swipe
            if (touchStartX - touchEndX > swipeThreshold) {
                // Swiped Left -> Next Slide
                moveSlide(1, true);
            } else if (touchEndX - touchStartX > swipeThreshold) {
                // Swiped Right -> Previous Slide
                moveSlide(-1, true);
            }
        }


        window.onload = async () => {
            // 1. Fetch data first - this now handles the initial switchFormat call
            const success = await fetchDesignData();
            if (!success) {
                showErrorPage();
                return;
            }

            // 2. Load visual assets
            await loadImages();
            await loadMockups();

            // 3. Initialize UI components
            initModalEvents();
            initTouchSlider();
            startAutoSlide();
            initCTAObserver();
        };

        function showErrorPage() {
            document.body.innerHTML = `
                <div class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
                    <div class="text-center">
                        <h1 class="display-1 fw-bold text-primary">404</h1>
                        <p class="fs-3 fw-semibold">Page Not Found</p>
                        <p class="lead text-muted">The design you are looking for does not exist or the link is invalid.</p>
                        <a href="/" class="btn btn-primary rounded-pill px-5 py-2 mt-3 fw-bold">Return Home</a>
                    </div>
                </div>
            `;
        }

        function getStarsHtml(rating) {
            let html = `<span class="rating-score">${rating}</span>`;
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.floor(rating)) {
                    html += `<i class="fas fa-star"></i>`;
                } else if (i === Math.floor(rating) + 1 && (rating % 1) >= 0.5) {
                    html += `<i class="fas fa-star-half-alt"></i>`;
                } else {
                    html += `<i class="far fa-star"></i>`;
                }
            }
            return html;
        }



        // Immediately nullify price on load to prevent flash of default text
        document.getElementById('priceValue').innerText = "";

        async function fetchDesignData() {
            try {
                const [designRes, brandsRes] = await Promise.all([
                    fetch(jsonPath),
                    fetch(brandsJsonPath)
                ]);

                if (!designRes.ok) return false;
                const designArray = await designRes.json();
                const designData = Array.isArray(designArray) ? designArray[0] : designArray;

                // --- 1. TITLE UPDATE (Guaranteed) ---
                const finalTitle = designData.title || "Wall Art Decor";
                document.title = finalTitle;
                // Select all elements with class 'hero-title'
                const titleElements = document.querySelectorAll('.hero-title');
                titleElements.forEach(el => {
                    el.innerText = finalTitle;
                    el.classList.remove('d-none'); // Ensure it's not hidden by Bootstrap classes
                });

                // --- 2. DOMAIN EXTRACTION ---
                const ctaUrl = designData.cta_url || "";
                let fullDomain = "Store.com";
                if (ctaUrl) {
                    try {
                        const urlObj = new URL(ctaUrl);
                        let hostname = urlObj.hostname.replace('www.', '');
                        fullDomain = hostname.charAt(0).toUpperCase() + hostname.slice(1);
                        platformName = hostname.split('.')[0].charAt(0).toUpperCase() + hostname.split('.')[0].slice(1);
                    } catch (e) {
                        fullDomain = "Store.com";
                    }
                }

                // --- 3. AVAILABILITY LOGIC ---
                const digitalAvailable = designData.digital_availability !== "no";
                const physicalAvailable = designData.physical_availability !== "no";
                const switcherContainer = document.querySelector('.format-switcher');

                if (digitalAvailable !== physicalAvailable) {
                    const icon = digitalAvailable ? 'fa-download' : 'fa-truck';
                    const label = digitalAvailable ? 'Instant Digital' : 'Physical Poster';

                    if (switcherContainer) {
                        switcherContainer.innerHTML = `
                    <div class="format-badge" id="availabilityBadge">
                        <i class="fas ${icon}" style="color: #0d6efd;"></i>
                        ${label}
                    </div>`;

                        const updateAlignment = () => {
                            const badge = document.getElementById('availabilityBadge');
                            if (!badge) return;
                            if (window.innerWidth <= 767.98) {
                                switcherContainer.style.justifyContent = "center";
                                badge.style.margin = "0 auto";
                            } else {
                                switcherContainer.style.justifyContent = "flex-start";
                                badge.style.margin = "0";
                            }
                        };
                        updateAlignment();
                        window.addEventListener('resize', updateAlignment);
                    }
                }

                // --- 4. DATA MAPPING & INITIAL SWITCH ---
                formats.digital.price = (designData.digital_price && designData.digital_price.trim() !== "") ? designData.digital_price : null;
                formats.physical.price = (designData.physical_price && designData.physical_price.trim() !== "") ? designData.physical_price : null;
                formats.digital.link = designData.digital_link || ctaUrl;
                formats.physical.link = designData.physical_link || ctaUrl;

                let initialType = (physicalAvailable) ? 'physical' : 'digital'
                    (digitalAvailable && !physicalAvailable) ? 'digital' :
                    (!digitalAvailable && physicalAvailable) ? 'physical' :
                        (urlParams.get('type') === 'physical') ? 'physical' : 'digital';

                switchFormat(initialType);

                // --- 5. BRAND TRUST & DOMAIN DISPLAY ---
                let brandsList = [];
                if (brandsRes.ok) brandsList = await brandsRes.json();

                const trustLink = document.getElementById('trustLink');
                const brandDomainDisplay = document.getElementById('brandDomainDisplay');
                const starRow = document.getElementById('starRow');
                const reviewCountText = document.getElementById('reviewCountText');
                const brandRatingsLabel = document.getElementById('brandRatingsLabel');

                const matchedBrand = brandsList.find(b => ctaUrl.toLowerCase().includes(b.domain.toLowerCase()));

                if (matchedBrand) {
                    trustLink.style.display = 'flex';
                    trustLink.href = ctaUrl;
                    if (brandDomainDisplay) brandDomainDisplay.innerText = fullDomain;


                    const fallback = matchedBrand.categories["posters"] || matchedBrand.categories["wall-art"] || {};
                    const finalRatings = designData.ratings ?? fallback.ratings;
                    const finalReviews = designData.reviews ?? fallback.reviews;

                    if (finalRatings) starRow.innerHTML = getStarsHtml(finalRatings);
                    if (finalReviews) reviewCountText.innerText = finalReviews + " reviews";
                }

                return true;
            } catch (error) {
                console.error("Initialization error:", error);
                return false;
            }
        }

        function switchFormat(type) {
            const data = formats[type];
            const platformText = platformName || "Store";

            const desc = document.getElementById('formatDesc');
            const clarityContainer = document.querySelector('.clarity-feature');
            const stepsContainer = document.getElementById('processStepsContainer');
            const heroCTA = document.getElementById('heroCTA');
            const priceContainer = document.getElementById('priceValueContainer');
            const floatingCTA = document.getElementById('floatingCTA');

            // Toggle active classes
            const optDigital = document.getElementById('opt-digital');
            const optPhysical = document.getElementById('opt-physical');
            if (optDigital) optDigital.classList.toggle('active', type === 'digital');
            if (optPhysical) optPhysical.classList.toggle('active', type === 'physical');

            if (desc) desc.innerHTML = data.desc;

            // --- Updated Checklist Logic ---
            if (clarityContainer) {
                const isDigital = type === 'digital';
                const sizeText = isDigital ? 'Multiple Sizes Available' : 'Multiple Sizes & Frames Available';
                const priceDependsText = 'Price depends on Size & Frame';

                clarityContainer.style.display = 'flex';
                clarityContainer.style.flexDirection = 'column';
                clarityContainer.style.alignItems = 'flex-start';
                clarityContainer.style.gap = '8px';

                // Build the list items
                let listHtml = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom:0.07in;">
            <i class="fas fa-circle-check" style="color: #198754;"></i>
            <p class="clarity-text" style="margin: 0;">${data.clarity}</p>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; ${!isDigital ? 'margin-bottom:0.07in;' : ''}">
            <i class="fas fa-circle-check" style="color: #198754;"></i>
            <p style="font-size: 1.1rem; font-weight: 700; color: #1a1a1a; margin: 0;">${sizeText}</p>
        </div>`;

                // Only add the third point if it is NOT digital
                if (!isDigital) {
                    listHtml += `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-circle-check" style="color: #198754;"></i>
            <p style="font-size: 1.1rem; font-weight: 700; color: #1a1a1a; margin: 0;">${priceDependsText}</p>
        </div>`;
                }

                clarityContainer.innerHTML = listHtml;
            }


            // Update Process Steps
            if (stepsContainer) {
                stepsContainer.innerHTML = data.steps.map((step, idx) => `
            <div class="step-item">
                <div class="step-icon"><i class="fas ${step.icon}"></i></div>
                <span class="step-label">${step.label}</span>
            </div>
            ${idx < data.steps.length - 1 ? '<i class="fas fa-chevron-right step-arrow"></i>' : ''}
        `).join('');
            }

            // Update CTA and Price
            const label = `Shop on ${platformText}`;
            if (heroCTA) { heroCTA.innerText = label; heroCTA.href = data.link; }
            if (floatingCTA) { floatingCTA.innerText = label; floatingCTA.href = data.link; }

            if (priceContainer) {
                if (data.price) {
                    priceContainer.style.display = 'block';
                    priceContainer.innerHTML = `Price: <span class="price-value">${data.price}</span>`;
                } else {
                    priceContainer.style.display = 'none';
                }
            }
        }


        function initCTAObserver() {
            const heroCTA = document.getElementById('heroCTA');
            const floatingCTA = document.getElementById('floatingCTA');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => entry.isIntersecting ? floatingCTA.classList.remove('visible') : floatingCTA.classList.add('visible'));
            }, { threshold: 0 });
            observer.observe(heroCTA);
        }

        async function tryFiles(name) {
            const extensions = ['png', 'jpg', 'jpeg'];
            const foundPaths = [];
            for (let ext of extensions) {
                const path = `${baseDir}${name}.${ext}`;
                const exists = await new Promise(r => { const img = new Image(); img.onload = () => r(true); img.onerror = () => r(false); img.src = path; });
                if (exists) foundPaths.push(path);
            }
            return foundPaths;
        }


        async function loadImages() {
            const track = document.getElementById('sliderTrack');
            const dots = document.getElementById('sliderDots');

            // Show a global loader for the slider initially
            track.innerHTML = `<div class="loading-spinner"><div class="spinner-border-custom"></div></div>`;

            const designPaths = await tryFiles('design');
            designPaths.forEach(p => images.push(p));

            let i = 1;
            while (i < 15) {
                const paths = await tryFiles(i);
                if (paths.length > 0) { paths.forEach(p => images.push(p)); i++; } else break;
            }

            // Clear loader and populate
            track.innerHTML = '';
            images.forEach((src, idx) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.minWidth = "100%";
                imgContainer.style.height = "100%";
                imgContainer.innerHTML = `<div class="loading-spinner"><div class="spinner-border-custom"></div></div>`;

                const img = document.createElement('img');
                img.src = src;
                img.style.display = 'none'; // Hide until loaded
                img.onclick = () => openModal(src);

                img.onload = () => {
                    imgContainer.innerHTML = ''; // Remove spinner
                    imgContainer.appendChild(img);
                    img.style.display = 'block';
                };

                track.appendChild(imgContainer);

                const dot = document.createElement('div');
                dot.className = `dot ${idx === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(idx, true);
                dots.appendChild(dot);
            });
            updateSlider();
        }

        async function loadMockups() {
            const grid = document.getElementById('mockupGrid');
            let mockupPaths = [];

            // 1. Gather all valid paths first
            const designPaths = await tryFiles('design');
            designPaths.forEach(p => mockupPaths.push(p));

            let j = 1;
            while (j < 15) {
                const paths = await tryFiles(j);
                if (paths.length > 0) { paths.forEach(p => mockupPaths.push(p)); j++; } else break;
            }

            let k = 1;
            while (k < 15) {
                const mockPaths = await tryFiles(`mock-${k}`);
                if (mockPaths.length > 0) { mockPaths.forEach(p => mockupPaths.push(p)); k++; } else break;
            }

            // 2. Create the placeholder divs with spinners
            mockupPaths.forEach(src => {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 mockup-item';

                // Add Loading Circle
                const loader = document.createElement('div');
                loader.className = 'loading-spinner';
                loader.innerHTML = '<div class="spinner-border-custom"></div>';
                col.appendChild(loader);

                const img = document.createElement('img');
                img.src = src;
                img.className = 'mockup-img';
                img.style.display = 'none';
                img.onclick = () => openModal(src);

                // 3. Logic to swap spinner for image once rendered
                img.onload = () => {
                    loader.remove();
                    img.style.display = 'block';
                };

                col.appendChild(img);
                grid.appendChild(col);
            });
        }


        function moveSlide(dir, manual = false) { if (manual) startAutoSlide(); currentSlide = (currentSlide + dir + images.length) % images.length; updateSlider(); }
        function goToSlide(index, manual = false) { if (manual) startAutoSlide(); currentSlide = index; updateSlider(); }
        function updateSlider() {
            const track = document.getElementById('sliderTrack');
            if (!track || images.length === 0) return;
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === currentSlide));
        }

        function startAutoSlide() {
            if (autoSlideTimer) clearInterval(autoSlideTimer);
            if (images.length <= 1) return;
            autoSlideTimer = setInterval(() => moveSlide(1), 5000);
        }


        function openModal(src) {
            const modal = document.getElementById('img-modal-overlay');
            const modalImg = document.getElementById('modal-zoom-img');
            modalImg.src = src;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            resetZoom();
            if (autoSlideTimer) clearInterval(autoSlideTimer);

            // --- NEW: Push a state so the back button closes the modal ---
            if (window.history.pushState) {
                window.history.pushState({ modalOpen: true }, "");
            }
        }


        function closeModal() {
            const modal = document.getElementById('img-modal-overlay');
            if (!modal.classList.contains('active')) return; // Already closed

            modal.classList.remove('active');
            document.body.style.overflow = '';
            startAutoSlide();

            // --- NEW: If modal was closed via "X" button, sync history ---
            // This prevents having to click "back" twice later
            if (window.history.state && window.history.state.modalOpen) {
                window.history.back();
            }
        }


        // Detect the browser back button
        window.addEventListener('popstate', function (event) {
            const modal = document.getElementById('img-modal-overlay');

            // If the modal is active and the user went "back", close it
            if (modal.classList.contains('active')) {
                // We pass 'false' or handle it carefully to avoid infinite history loops
                modal.classList.remove('active');
                document.body.style.overflow = '';
                startAutoSlide();
            }
        });


        function resetZoom() { zoomLevel = 1; translateX = 0; translateY = 0; updateZoomTransform(); }
        function updateZoomTransform() {
            const modalImg = document.getElementById('modal-zoom-img');
            const percentText = document.getElementById('zoom-percent-text');
            modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
            percentText.innerText = Math.round(zoomLevel * 100) + '%';
        }

        function initModalEvents() {
            const modal = document.getElementById('img-modal-overlay');
            const container = document.getElementById('modal-container');
            const modalImg = document.getElementById('modal-zoom-img');
            document.getElementById('close-view-modal').onclick = closeModal;

            document.getElementById('btn-zoom-in').onclick = () => { zoomLevel = Math.min(zoomLevel + 0.5, 4); updateZoomTransform(); };
            document.getElementById('btn-zoom-out').onclick = () => { zoomLevel = Math.max(zoomLevel - 0.5, 1); if (zoomLevel === 1) { translateX = 0; translateY = 0; } updateZoomTransform(); };

            container.addEventListener('wheel', (e) => { e.preventDefault(); if (e.deltaY < 0) zoomLevel = Math.min(zoomLevel + 0.25, 4); else { zoomLevel = Math.max(zoomLevel - 0.25, 1); if (zoomLevel === 1) { translateX = 0; translateY = 0; } } updateZoomTransform(); }, { passive: false });

            const toggleZoom = () => {
                if (zoomLevel > 1) { zoomLevel = 1; translateX = 0; translateY = 0; }
                else { zoomLevel = 2; }
                updateZoomTransform();
            };
            container.addEventListener('dblclick', toggleZoom);

            let lastTap = 0;
            let initialPinchDist = null;
            let startZoomLevel = 1;

            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const now = Date.now();
                    if (now - lastTap < 300) { toggleZoom(); e.preventDefault(); }
                    lastTap = now;

                    if (zoomLevel > 1) {
                        isDragging = true;
                        startX = e.touches[0].clientX - translateX;
                        startY = e.touches[0].clientY - translateY;
                    }
                } else if (e.touches.length === 2) {
                    isDragging = false;
                    initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    startZoomLevel = zoomLevel;
                }
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isDragging) {
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    updateZoomTransform();
                } else if (e.touches.length === 2 && initialPinchDist) {
                    const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    const scale = currentDist / initialPinchDist;
                    zoomLevel = Math.min(Math.max(startZoomLevel * scale, 1), 5);
                    updateZoomTransform();
                }
            }, { passive: false });

            container.addEventListener('touchend', () => { isDragging = false; initialPinchDist = null; });

            container.onmousedown = (e) => { if (zoomLevel <= 1) return; isDragging = true; startX = e.clientX - translateX; startY = e.clientY - translateY; };
            window.onmousemove = (e) => { if (!isDragging) return; translateX = e.clientX - startX; translateY = e.clientY - startY; updateZoomTransform(); };
            window.onmouseup = () => isDragging = false;
        }
    </script>
</body>

</html>